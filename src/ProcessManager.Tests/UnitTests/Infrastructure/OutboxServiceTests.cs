using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;
using MediatR;
using Microsoft.Extensions.Logging;
using Moq;
using ProcessManager.Domain.DomainEvents;
using ProcessManager.Domain.Interfaces;
using ProcessManager.Domain.Models;
using ProcessManager.Infrastructure.Services;
using Xunit;

namespace ProcessManager.Tests.UnitTests.Infrastructure
{
    public class OutboxServiceTests
    {
        private readonly Mock<IUnitOfWork> _unitOfWorkMock = new Mock<IUnitOfWork>();
        private readonly Mock<IEventNotificationService> _eventNotificationServiceMock = new Mock<IEventNotificationService>();
        private readonly Mock<IProcessService> _processServiceMock = new Mock<IProcessService>();
        private readonly Mock<IMediator> _mediatorMock = new Mock<IMediator>();
        private readonly Mock<IWorkflowRepository> _workflowRepository = new Mock<IWorkflowRepository>();
        private readonly ILogger<OutboxService> _mockLoggerObject = new Mock<ILogger<OutboxService>>().Object;

        [Fact]
        public async Task SendEvents_UnprocessedEvents_Successful()
        {
            var outboxMessageId = Guid.NewGuid();
            _unitOfWorkMock.Setup(x => x.OutboxRepository.GetUnprocessedEventsAsync(It.IsAny<CancellationToken>()))
                .ReturnsAsync(new List<OutboxMessage>
                {
                    new OutboxMessage
                    {
                        OutboxMessageId = outboxMessageId,
                        MessageId = Guid.NewGuid(),
                        CreatedDate = DateTime.Now,
                        Type = OutboxMessageType.EventGrid,
                        Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessFailed, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"message\\\":\\\"5 unhandled exceptions: 10/4/2021 1:53:13 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:20 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:26 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:30 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:36 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\",\\\"correlationId\\\":\\\"5f6301b1-a892-4191-9d56-a04e30017a70\\\",\\\"requestId\\\":\\\"ddf7c83b-4795-4832-a271-471b2daa118e\\\",\\\"commandId\\\":\\\"4fe31e8b-6fcf-4c77-a7f2-4db3e5461bca\\\",\\\"operationId\\\":\\\"c5629d40-8286-4c93-90c4-f55666fe23c0\\\",\\\"createdDate\\\":\\\"2021-10-04T11:53:43.5031356Z\\\"}\",\"subject\":\"api/Workflows/c5629d40-8286-4c93-90c4-f55666fe23c0\"}",
                        ProcessedDate = null
                    }
                });
            var service = new OutboxService(_unitOfWorkMock.Object, _workflowRepository.Object ,_eventNotificationServiceMock.Object, _processServiceMock.Object, _mediatorMock.Object, _mockLoggerObject);

            await service.SendEventsAsync();

            _unitOfWorkMock.Verify(x => x.OutboxRepository.GetUnprocessedEventsAsync(It.IsAny<CancellationToken>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.OutboxRepository.Update(It.IsAny<OutboxMessage>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Once());
            _eventNotificationServiceMock.Verify(x => x.SendAsync(It.IsAny<object>(), It.IsAny<string>()), Times.Once());
        }

        [Fact]
        public async Task SendEvents_NoUnprocessedEvents_Successful()
        {
            _unitOfWorkMock.Setup(x => x.OutboxRepository.GetUnprocessedEventsAsync(It.IsAny<CancellationToken>()))
                .ReturnsAsync(new List<OutboxMessage>());
            var service = new OutboxService(_unitOfWorkMock.Object,_workflowRepository.Object, _eventNotificationServiceMock.Object, _processServiceMock.Object, _mediatorMock.Object, _mockLoggerObject);

            await service.SendEventsAsync();

            _unitOfWorkMock.Verify(x => x.OutboxRepository.GetUnprocessedEventsAsync(It.IsAny<CancellationToken>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.OutboxRepository.Update(It.IsAny<OutboxMessage>()), Times.Never());
            _unitOfWorkMock.Verify(x => x.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never());
            _eventNotificationServiceMock.Verify(x => x.SendAsync(It.IsAny<object>(), It.IsAny<string>()), Times.Never());
        }

        [Fact]
        public async Task StartLogicApps_UnprocessedLogicApps_Successful()
        {
            var outboxMessageId = Guid.NewGuid();
            _unitOfWorkMock.Setup(x => x.OutboxRepository.GetLogicAppStartMessagesAsync(It.IsAny<CancellationToken>()))
                .ReturnsAsync(new List<OutboxMessage>
                {
                    new OutboxMessage
                    {
                        OutboxMessageId = outboxMessageId,
                        MessageId = Guid.NewGuid(),
                        CreatedDate = DateTime.Now,
                        Type = OutboxMessageType.LogicApp,
                        Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessSucceeded, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"correlationId\\\":\\\"1a3c214c-5818-463b-b4de-8d1bc8176fa3\\\",\\\"requestId\\\":\\\"43b2bee8-c17c-4fe9-b5ab-7290bd171c94\\\",\\\"commandId\\\":\\\"da5a046b-3f27-4596-8175-6324567e7956\\\",\\\"operationId\\\":\\\"a8aa3a49-e726-4838-a585-d7b109c8eedd\\\",\\\"createdDate\\\":\\\"2021-12-03T10:28:17.1567457Z\\\"}\",\"subject\":\"api/Workflows/a8aa3a49-e726-4838-a585-d7b109c8eedd\",\"process\":{\"parameters\":{\"startMessage\":{\"processKey\":\"Create-Person\",\"processName\":\"Create-Person\",\"operationId\":\"a8aa3a49-e726-4838-a585-d7b109c8eedd\",\"correlationId\":\"1a3c214c-5818-463b-b4de-8d1bc8176fa3\",\"entityRelations\":null,\"personId\":\"156a60a5-6b10-4952-a7de-238dd840473f\",\"firstName\":\"Salvador\",\"lastName\":\"Dach\",\"initials\":null,\"middleName\":null,\"prefixLastName\":null,\"birthName\":null,\"genderReferenceId\":null,\"maritalStatusReferenceId\":null,\"birthDate\":null,\"nationalityReferenceId\":null,\"socialSecurityNumber\":null,\"socialSecurityNumberCountryReferenceId\":null,\"placeOfBirth\":null,\"countryOfBirthReferenceId\":null,\"preferredLanguageReferenceId\":null,\"salutation\":null,\"notes\":null,\"contact\":null,\"identityDocument\":null,\"knowYourCustomer\":null,\"address\":[{\"addressTypeReferenceId\":null,\"addressLine1\":\"Pete Fields\",\"addressLine2\":null,\"city\":null,\"postalCode\":null,\"region\":null,\"countryReferenceId\":null}],\"customField\":null},\"createdBy\":\"71f821ca-bf67-4b2a-938e-d0dabe3855fd\",\"externalId\":\"764c8e99-c059-4923-8ff6-b8102592429d\",\"operationId\":\"a8aa3a49-e726-4838-a585-d7b109c8eedd\",\"featureFlags\":[]},\"key\":\"Create-Person\",\"startUrl\":\"https://prod-161.westeurope.logic.azure.com:443/workflows/7fb2b0e5b1334394a262435c3a764316/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xPgqsPE5TgB_-1fVA4ek2PHM_QrykdXkSYqD0yiSK08\"},\"headers\":{\"x-external-id\":\"71f821ca-bf67-4b2a-938e-d0dabe3855fd\",\"x-user-id\":\"71f821ca-bf67-4b2a-938e-d0dabe3855fd\",\"x-request-id\":\"43b2bee8-c17c-4fe9-b5ab-7290bd171c94\",\"x-command-id\":\"da5a046b-3f27-4596-8175-6324567e7956\",\"rbs2-intent\":\"pub\",\"rbs2-msg-id\":\"c6948a1b-e60c-4cdf-8886-af6b80c4fd4e\",\"rbs2-senttime\":\"2021-12-03T11:27:49.5112185+01:00\",\"rbs2-msg-type\":\"FiveDegrees.Messages.CdmPerson.StartCreatePersonMsg, FiveDegrees.Messages\",\"rbs2-corr-id\":\"c6948a1b-e60c-4cdf-8886-af6b80c4fd4e\",\"rbs2-corr-seq\":\"0\",\"rbs2-content-type\":\"application/json;charset=utf-8\"}}",
                        ProcessedDate = null
                    }
                });
            var service = new OutboxService(_unitOfWorkMock.Object, _workflowRepository.Object, _eventNotificationServiceMock.Object, _processServiceMock.Object, _mediatorMock.Object, _mockLoggerObject);

            await service.StartLogicAppsAsync();

            _unitOfWorkMock.Verify(x => x.OutboxRepository.GetLogicAppStartMessagesAsync(It.IsAny<CancellationToken>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.OutboxRepository.Update(It.IsAny<OutboxMessage>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Once());
            _processServiceMock.Verify(x => x.StartProcessAsync(It.IsAny<Process>(), It.Is<Dictionary<string, string>>(x => x["x-request-id"] == "43b2bee8-c17c-4fe9-b5ab-7290bd171c94" && x["x-command-id"] == "da5a046b-3f27-4596-8175-6324567e7956")), Times.Once());
            _mediatorMock.Verify(x => x.Publish(It.IsAny<StartLogicAppDomainFailed>(), It.IsAny<CancellationToken>()), Times.Never());
        }

        [Fact]
        public async Task StartLogicApps_UnprocessedLogicApps_Failed()
        {
            var outboxMessageId = Guid.NewGuid();
            _unitOfWorkMock.Setup(x => x.OutboxRepository.GetLogicAppStartMessagesAsync(It.IsAny<CancellationToken>()))
                .ReturnsAsync(new List<OutboxMessage>
                {
                    new OutboxMessage
                    {
                        OutboxMessageId = outboxMessageId,
                        MessageId = Guid.NewGuid(),
                        CreatedDate = DateTime.Now,
                        Type = OutboxMessageType.LogicApp,
                        Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessSucceeded, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"correlationId\\\":\\\"1a3c214c-5818-463b-b4de-8d1bc8176fa3\\\",\\\"requestId\\\":\\\"43b2bee8-c17c-4fe9-b5ab-7290bd171c94\\\",\\\"commandId\\\":\\\"da5a046b-3f27-4596-8175-6324567e7956\\\",\\\"operationId\\\":\\\"a8aa3a49-e726-4838-a585-d7b109c8eedd\\\",\\\"createdDate\\\":\\\"2021-12-03T10:28:17.1567457Z\\\"}\",\"subject\":\"api/Workflows/a8aa3a49-e726-4838-a585-d7b109c8eedd\",\"process\":{\"parameters\":{\"startMessage\":{\"processKey\":\"Create-Person\",\"processName\":\"Create-Person\",\"operationId\":\"a8aa3a49-e726-4838-a585-d7b109c8eedd\",\"correlationId\":\"1a3c214c-5818-463b-b4de-8d1bc8176fa3\",\"entityRelations\":null,\"personId\":\"156a60a5-6b10-4952-a7de-238dd840473f\",\"firstName\":\"Salvador\",\"lastName\":\"Dach\",\"initials\":null,\"middleName\":null,\"prefixLastName\":null,\"birthName\":null,\"genderReferenceId\":null,\"maritalStatusReferenceId\":null,\"birthDate\":null,\"nationalityReferenceId\":null,\"socialSecurityNumber\":null,\"socialSecurityNumberCountryReferenceId\":null,\"placeOfBirth\":null,\"countryOfBirthReferenceId\":null,\"preferredLanguageReferenceId\":null,\"salutation\":null,\"notes\":null,\"contact\":null,\"identityDocument\":null,\"knowYourCustomer\":null,\"address\":[{\"addressTypeReferenceId\":null,\"addressLine1\":\"Pete Fields\",\"addressLine2\":null,\"city\":null,\"postalCode\":null,\"region\":null,\"countryReferenceId\":null}],\"customField\":null},\"createdBy\":\"71f821ca-bf67-4b2a-938e-d0dabe3855fd\",\"externalId\":\"764c8e99-c059-4923-8ff6-b8102592429d\",\"operationId\":\"a8aa3a49-e726-4838-a585-d7b109c8eedd\",\"featureFlags\":[]},\"key\":\"Create-Person\",\"startUrl\":\"https://prod-161.westeurope.logic.azure.com:443/workflows/7fb2b0e5b1334394a262435c3a764316/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xPgqsPE5TgB_-1fVA4ek2PHM_QrykdXkSYqD0yiSK08\"},\"headers\":{\"x-external-id\":\"71f821ca-bf67-4b2a-938e-d0dabe3855fd\",\"x-user-id\":\"71f821ca-bf67-4b2a-938e-d0dabe3855fd\",\"x-request-id\":\"43b2bee8-c17c-4fe9-b5ab-7290bd171c94\",\"x-command-id\":\"da5a046b-3f27-4596-8175-6324567e7956\",\"rbs2-intent\":\"pub\",\"rbs2-msg-id\":\"c6948a1b-e60c-4cdf-8886-af6b80c4fd4e\",\"rbs2-senttime\":\"2021-12-03T11:27:49.5112185+01:00\",\"rbs2-msg-type\":\"FiveDegrees.Messages.CdmPerson.StartCreatePersonMsg, FiveDegrees.Messages\",\"rbs2-corr-id\":\"c6948a1b-e60c-4cdf-8886-af6b80c4fd4e\",\"rbs2-corr-seq\":\"0\",\"rbs2-content-type\":\"application/json;charset=utf-8\"}}",
                        ProcessedDate = null
                    }
                });
            _processServiceMock.Setup(x => x.StartProcessAsync(It.IsAny<Process>(), It.IsAny<Dictionary<string, string>>()))
                .Throws(new Exception());

            var service = new OutboxService(_unitOfWorkMock.Object, _workflowRepository.Object, _eventNotificationServiceMock.Object, _processServiceMock.Object, _mediatorMock.Object, _mockLoggerObject);

            await service.StartLogicAppsAsync();

            _unitOfWorkMock.Verify(x => x.OutboxRepository.GetLogicAppStartMessagesAsync(It.IsAny<CancellationToken>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.OutboxRepository.Update(It.IsAny<OutboxMessage>()), Times.Never());
            _unitOfWorkMock.Verify(x => x.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never());
            _processServiceMock.Verify(x => x.StartProcessAsync(It.IsAny<Process>(), It.Is<Dictionary<string, string>>(x => x["x-request-id"] == "43b2bee8-c17c-4fe9-b5ab-7290bd171c94" && x["x-command-id"] == "da5a046b-3f27-4596-8175-6324567e7956")), Times.Once());
            _mediatorMock.Verify(x => x.Publish(It.IsAny<StartLogicAppDomainFailed>(), It.IsAny<CancellationToken>()), Times.Once());
        }

        [Fact]
        public async Task StartLogicApps_NoUnprocessedLogicApps_Successful()
        {
            _unitOfWorkMock.Setup(x => x.OutboxRepository.GetLogicAppStartMessagesAsync(It.IsAny<CancellationToken>()))
                .ReturnsAsync(new List<OutboxMessage>());
            var service = new OutboxService(_unitOfWorkMock.Object, _workflowRepository.Object, _eventNotificationServiceMock.Object, _processServiceMock.Object, _mediatorMock.Object, _mockLoggerObject);

            await service.StartLogicAppsAsync();

            _unitOfWorkMock.Verify(x => x.OutboxRepository.GetLogicAppStartMessagesAsync(It.IsAny<CancellationToken>()), Times.Once());
            _unitOfWorkMock.Verify(x => x.OutboxRepository.Update(It.IsAny<OutboxMessage>()), Times.Never());
            _unitOfWorkMock.Verify(x => x.SaveChangesAsync(It.IsAny<CancellationToken>()), Times.Never());
            _processServiceMock.Verify(x => x.StartProcessAsync(It.IsAny<Process>(), It.IsAny<Dictionary<string, string>>()), Times.Never());
            _mediatorMock.Verify(x => x.Publish(It.IsAny<StartLogicAppDomainFailed>(), It.IsAny<CancellationToken>()), Times.Never());
        }
    }
}
