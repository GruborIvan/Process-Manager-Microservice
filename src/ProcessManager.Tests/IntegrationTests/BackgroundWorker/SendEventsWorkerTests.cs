using System;
using System.Linq;
using System.Threading.Tasks;
using Autofac;
using Autofac.Extensions.DependencyInjection;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Moq;
using ProcessManager.Domain.Models;
using ProcessManager.Infrastructure.Models;
using ProcessManager.Infrastructure.Modules;
using Xunit;

namespace ProcessManager.Tests.IntegrationTests.BackgroundWorker
{
    public class SendEventsWorkerTests : TestFixture
    {
        private readonly IHost _host;

        public SendEventsWorkerTests()
        {
            hostBuilder.ConfigureContainer<ContainerBuilder>(builder =>
                {
                    builder.RegisterModule(
                        new ProcessManager.BackgroundWorker.SendEvents.Modules.AutoMapperModule(typeof(InfrastructureModule)
                            .Assembly));
                })
                .ConfigureServices((hostContext, services) =>
                {
                    services.AddHostedService<ProcessManager.BackgroundWorker.SendEvents.Worker>();
                });
            _host = hostBuilder.Start();
        }

        [Fact]
        public async Task OneUnprocessedMessage_SendEventsWorker_ProcessMessagesAndSendEvents()
        {
            // Arrange 
            var outboxMessageDbo = new OutboxMessageDbo
            {
                MessageId = Guid.NewGuid(),
                Type = OutboxMessageType.EventGrid,
                Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessFailed, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"message\\\":\\\"5 unhandled exceptions: 10/4/2021 1:53:13 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:20 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:26 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:30 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:36 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\",\\\"correlationId\\\":\\\"5f6301b1-a892-4191-9d56-a04e30017a70\\\",\\\"requestId\\\":\\\"ddf7c83b-4795-4832-a271-471b2daa118e\\\",\\\"commandId\\\":\\\"4fe31e8b-6fcf-4c77-a7f2-4db3e5461bca\\\",\\\"operationId\\\":\\\"c5629d40-8286-4c93-90c4-f55666fe23c0\\\",\\\"createdDate\\\":\\\"2021-10-04T11:53:43.5031356Z\\\"}\",\"subject\":\"api/Workflows/c5629d40-8286-4c93-90c4-f55666fe23c0\"}",
                ProcessedDate = null
            };
            var processedOutboxMessageDbo = new OutboxMessageDbo
            {
                MessageId = Guid.NewGuid(),
                Type = OutboxMessageType.EventGrid,
                Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessFailed, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"message\\\":\\\"5 unhandled exceptions: 10/4/2021 1:53:13 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:20 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:26 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:30 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:36 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\",\\\"correlationId\\\":\\\"5f6301b1-a892-4191-9d56-a04e30017a70\\\",\\\"requestId\\\":\\\"ddf7c83b-4795-4832-a271-471b2daa118e\\\",\\\"commandId\\\":\\\"4fe31e8b-6fcf-4c77-a7f2-4db3e5461bca\\\",\\\"operationId\\\":\\\"c5629d40-8286-4c93-90c4-f55666fe23c0\\\",\\\"createdDate\\\":\\\"2021-10-04T11:53:43.5031356Z\\\"}\",\"subject\":\"api/Workflows/c5629d40-8286-4c93-90c4-f55666fe23c0\"}",
                ProcessedDate = DateTime.UtcNow
            };
            using var context = Resolve<ProcesManagerDbContext>();
            context.OutboxMessages.AddRange(outboxMessageDbo, processedOutboxMessageDbo);
            context.SaveChanges();

            await Task.Delay(2500);

            //Act
            var outboxMessages = context.OutboxMessages.Where(x => x.ProcessedDate == null).ToList();

            // Assert
            Assert.Empty(outboxMessages);
            mockEventGridService.Verify(x=>x.SendAsync(It.IsAny<object>(), It.IsAny<string>()), Times.Once);
        }

        [Fact]
        public async Task TwoUnprocessedMessage_SendEventsWorker_ProcessMessagesAndSendEvents()
        {
            // Arrange 
            var outboxMessageDbo = new OutboxMessageDbo
            {
                MessageId = Guid.NewGuid(),
                Type = OutboxMessageType.EventGrid,
                Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessFailed, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"message\\\":\\\"5 unhandled exceptions: 10/4/2021 1:53:13 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:20 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:26 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:30 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:36 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\",\\\"correlationId\\\":\\\"5f6301b1-a892-4191-9d56-a04e30017a70\\\",\\\"requestId\\\":\\\"ddf7c83b-4795-4832-a271-471b2daa118e\\\",\\\"commandId\\\":\\\"4fe31e8b-6fcf-4c77-a7f2-4db3e5461bca\\\",\\\"operationId\\\":\\\"c5629d40-8286-4c93-90c4-f55666fe23c0\\\",\\\"createdDate\\\":\\\"2021-10-04T11:53:43.5031356Z\\\"}\",\"subject\":\"api/Workflows/c5629d40-8286-4c93-90c4-f55666fe23c0\"}",
                ProcessedDate = null
            };
            var outboxMessageDbo2 = new OutboxMessageDbo
            {
                MessageId = Guid.NewGuid(),
                Type = OutboxMessageType.EventGrid,
                Data = "{\"data\":\"{\\\"$type\\\":\\\"ProcessManager.Domain.Events.StartProcessFailed, ProcessManager.Domain\\\",\\\"processName\\\":\\\"Create-Person\\\",\\\"message\\\":\\\"5 unhandled exceptions: 10/4/2021 1:53:13 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:20 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:26 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:30 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\\r\\\\n10/4/2021 1:53:36 PM +02:00: System.Net.Http.HttpRequestException: Response status code does not indicate success: 401 (Unauthorized).\\\\r\\\\n   at System.Net.Http.HttpResponseMessage.EnsureSuccessStatusCode()\\\\r\\\\n   at ProcessManager.Infrastructure.Services.LogicAppProcessService.GetPrincipalIdAsync(String processName) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Infrastructure\\\\\\\\Services\\\\\\\\LogicAppProcessManager.cs:line 85\\\\r\\\\n   at ProcessManager.Domain.Commands.StartProcessCommandHandler.Handle(StartProcessCommand request, CancellationToken cancellationToken) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.Domain\\\\\\\\Commands\\\\\\\\StartProcessCommandHandler.cs:line 43\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.HandleProcessMessage(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 68\\\\r\\\\n   at ProcessManager.BackgroundWorker.Handlers.StartProcessMessageHandler.Handle(IStartProcessMsg message) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Handlers\\\\\\\\StartProcessMessageHandler.cs:line 39\\\\r\\\\n   at Rebus.Pipeline.Receive.HandlerInvoker`1.Invoke()\\\\r\\\\n   at Rebus.Pipeline.Receive.DispatchIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at FiveDegrees.Audit.Rebus.RebusSteps.IncomingPreDispatchAuditStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Sagas.LoadSagaDataStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.ActivateHandlersStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Pipeline.Receive.HandleRoutingSlipsStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.FailedMessageWrapperStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at ProcessManager.BackgroundWorker.Extensions.MessageDeDuplicationIncomingStep.Process(IncomingStepContext context, Func`1 next) in D:\\\\\\\\Reloaded\\\\\\\\src\\\\\\\\Services\\\\\\\\ProcessManager\\\\\\\\ProcessManager.BackgroundWorker\\\\\\\\Extensions\\\\\\\\Steps.cs:line 27\\\\r\\\\n   at Rebus.Pipeline.Receive.DeserializeIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.DataBus.ClaimCheck.HydrateIncomingMessageStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.FailFast.FailFastStep.Process(IncomingStepContext context, Func`1 next)\\\\r\\\\n   at Rebus.Retry.Simple.SimpleRetryStrategyStep.DispatchWithTrackerIdentifier(Func`1 next, String identifierToTrackMessageBy, ITransactionContext transactionContext, String messageId, String secondLevelMessageId)\\\",\\\"correlationId\\\":\\\"5f6301b1-a892-4191-9d56-a04e30017a70\\\",\\\"requestId\\\":\\\"ddf7c83b-4795-4832-a271-471b2daa118e\\\",\\\"commandId\\\":\\\"4fe31e8b-6fcf-4c77-a7f2-4db3e5461bca\\\",\\\"operationId\\\":\\\"c5629d40-8286-4c93-90c4-f55666fe23c0\\\",\\\"createdDate\\\":\\\"2021-10-04T11:53:43.5031356Z\\\"}\",\"subject\":\"api/Workflows/c5629d40-8286-4c93-90c4-f55666fe23c0\"}",
                ProcessedDate = null
            };
            using var context = Resolve<ProcesManagerDbContext>();
            context.OutboxMessages.AddRange(outboxMessageDbo, outboxMessageDbo2);
            context.SaveChanges();

            await Task.Delay(2500);

            //Act
            var outboxMessages = context.OutboxMessages.Where(x => x.ProcessedDate == null).ToList();

            // Assert
            Assert.Empty(outboxMessages);
            mockEventGridService.Verify(x => x.SendAsync(It.IsAny<object>(), It.IsAny<string>()), Times.Exactly(2));
        }

        private TResult Resolve<TResult>()
        {
            return _host.Services.GetAutofacRoot().Resolve<TResult>();
        }
    }
}
