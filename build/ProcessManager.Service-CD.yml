name: $(Build.DefinitionName).$(Build.SourceBranchName).$(BuildID)
 
parameters:
- name: platformName
  displayName: Platform Name
  type: string
  default: devpfm
- name: tenantShortName
  displayName: Tenant short name
  type: string
  default: k3y
  values:
  - inf
  - len
  - arch
  - fat
  - sntl
  - s1s
  - tc1s
  - k3y
  - gud
  - bad
- name: environmentShortName
  displayName: Environment Short Name
  type: string
  default: sbx
  values:
  - sbx
  - stg
  - prd
- name: sharedVariableGroupName
  displayName: Shared Variable Group Name
  type: string
  default: MY-DEVTST-SHARED
  values:
  - MY-DEVTST-SHARED
- name: subscriptionVariableGroupName
  displayName: Subscription Name
  type: string
  default: MY-DEVTST05
  values:
  - MY-DEVTST03
  - MY-DEVTST04
  - MY-DEVTST05
  - MY-DEVTST
- name: reloadedFeedView
  displayName: Feed view
  type: string
  default: Local
  values:
  - Local
  - Integration
  - Prerelease
  - Release
- name: Deployment_level
  displayName: Deployment level
  type: string
  default: env
  values:
  - env
  - tenant
  - platform
- name: VersionTagFilter
  displayName: VersionTagFilter
  type: string
  default: '*'

resources:
#Add Devops repository where templates are located
  repositories:
  - repository: devops
    type: git
    name: unity/unity
    ref: 'develop' #always use develop branch where stable code is stored 

trigger: none
pool:
  name: $(pool)
  vmimage: 'windows-latest'

variables:
  - name: platformName
    value: ${{ parameters.platformName }}
  - name: tenantShortName
    value: ${{ parameters.tenantShortName }}
  - name: environmentShortName
    value: ${{ parameters.environmentShortName }}
  - name: reloadedFeedView
    value: ${{ parameters.reloadedFeedView }}
    #VersionTagFilter is defined in parameters
  - name: VersionTagFilter
    value: '${{parameters.VersionTagFilter}}' 
  - name: deployWebApps
    value: true
  - name: resourceLevel
    value: '${{parameters.Deployment_level}}' # platform, tenant or env
 # API Management variables
  - ${{if ne(variables.resourceLevel, 'platform')}}:
    - name: apimResourceGroup
      value: "$(platformName)-$(tenantShortName)-tnt-rg"
    - name: apimName
      value: "$(platformName)-$(tenantShortName)-apim"
  - ${{if eq(variables.resourceLevel, 'platform')}}:
    - name: apimResourceGroup
      value: "$(platformName)-platform-rg" # for platform services its $(platformName)-platform-rg
    - name: apimName
      value: "$(platformName)-apim" # for platform services its $(platformName)-apim
  - group: ${{ parameters.sharedVariableGroupName }}
  - group: ${{ parameters.subscriptionVariableGroupName }}
   
    
stages:
  - stage: Deploy_Service
    displayName: 'Deploy service ProcessManager.Service'
    jobs:
    - template: Pipelines/Templates/Jobs/deployWebAppsJob.yml@devops
      parameters:
        repoAlias: 'devops'
        deployFeature: true
        runDeploymentJob: true
        versionTagFilter: $(VersionTagFilter)
        organization: $(reloadedFeedOrganization)
        project: $(reloadedFeedProjectName)
        packageFeedName: $(reloadedFeedName)
        packageFeedView: $(reloadedFeedView)
        packageFeedAccessToken: ${{ coalesce( variables.reloadedFeedAccessToken, '$(System.AccessToken)' ) }}
        webApps:
        - ${{if eq(variables.resourceLevel, 'platform')}}:
          - packageName: "ProcessManager.Service"
            resourceGroupName: "$(platformName)-platform-rg"
            webAppName: "$(platformName)-processmanagersvc"
            apiName: "processmanager"
            apimImport: true
        - ${{if eq(variables.resourceLevel, 'tenant')}}:
          - packageName: "ProcessManager.Service"
            resourceGroupName: "$(platformName)-$(tenantShortName)-tnt-rg"
            webAppName: "$(platformName)-$(tenantShortName)-processmanagersvc"
            apiName: "processmanager"
            apimImport: true
        - ${{if eq(variables.resourceLevel, 'env')}}:
          - packageName: "ProcessManager.Service"
            resourceGroupName: "$(platformName)-$(tenantShortName)-$(environmentShortName)-rg"
            webAppName: "$(platformName)-$(tenantShortName)-$(environmentShortName)-processmanagersvc"
            apiName: "processmanager-$(environmentShortName)"
            apimImport: true