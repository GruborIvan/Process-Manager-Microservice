name: $(Build.DefinitionName).$(Build.SourceBranchName).$(BuildID)

resources:
  repositories:
  #Add Devops repository where templates are located
  - repository: devops
    type: git
    name: unity/unity
    ref: 'develop' #always use develop branch where stable code is stored
 
trigger:
  batch: true
  branches:
    include:
    - main
    - release/*
  paths:
    include:
    - src/ProcessManager.API
    - src/ProcessManager.BackgroundWorker
    - src/ProcessManager.BackgroundWorker.SendEvents
    - src/ProcessManager.BackgroundWorker.StartLogicApps
    - src/ProcessManager.Domain
    - src/ProcessManager.Infrastructure

pool:
  name: $(pool)
  vmImage: 'windows-latest'


variables:
  #include variable group
  - group: my-devtst-shared-vg
  
stages:
- stage: Build_Service
  displayName: 'Build stage'
  variables:
  - name:  BuildConfiguration
    value: Release
  - name: BuildPlatform
    value: 'any cpu'  
  jobs:
  - job: Build_Service_Job
    displayName: 'Build job'
    steps:
    - checkout: devops
    - checkout: self

    - task: UseDotNet@2
      displayName: 'Use .Net 6.0.x'
      inputs:
        version: 6.0.x
    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/ProcessManager.sln'
        feedsToUse: 'config'
        nugetConfigPath: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/NuGet.config'
    - task: SonarQubePrepare@4
      displayName: Prepare Sonar Qube Analysis
      inputs:
        SonarQube: 'FD Sonar-Core'
        scannerMode: 'MSBuild'
        projectKey: 'ProcessManager.Service'
        projectName: 'ProcessManager.Service'
        extraProperties: |
          sonar.cs.opencover.reportsPaths="$(Build.SourcesDirectory)\TestResults\coverage.opencover.xml"
          sonar.coverage.exclusions=**/FiveDegrees.Messages/**,**/Program.cs,**/Startup.cs
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        projects: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/ProcessManager.sln'
        arguments: '--configuration $(BuildConfiguration)'
    - task: DotNetCoreCLI@2
      enabled: true
      displayName: Test
      inputs:
        command: test
        projects: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/ProcessManager.sln'
        arguments: '--configuration $(BuildConfiguration) --logger "trx;LogFileName=$(Build.SourcesDirectory)\TestResults\results.trx" /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=$(Build.SourcesDirectory)\TestResults\ /p:Threshold=0 /p:ThresholdStat=average /p:Exclude=[FiveDegrees.Messages]*%2c[*API]*Program%2c[*API]*Startup%2c[*BackgroundWorker]*Program%2c[*BackgroundWorker]*Startup%2c[*Infrastructure]*Migrations*'
    - task: PublishCodeCoverageResults@1
      displayName: 'Publish code coverage results'
      inputs:
        codeCoverageTool: Cobertura
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.opencover.xml'
        reportDirectory: '$(System.DefaultWorkingDirectory)/**/coverage'
      condition: succeededOrFailed()
    - task: SonarQubeAnalyze@4
      displayName: Run Sonar Qube Analysis
    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: false
        projects: |
          **/ProcessManager/**/*.csproj
          **/ProcessManager/**/*.sqlproj
        arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'
        zipAfterPublish: false
        modifyOutputPath: true
    - task: CopyFiles@2
      displayName: 'Copy ProcessManager.BackgroundWorker to ProcessManager.API folder'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)/ProcessManager.BackgroundWorker'
        TargetFolder: '$(build.artifactstagingdirectory)/ProcessManager.API/App_Data/jobs/continuous/ProcessManager.BackgroundWorker/'
    - pwsh: |
       "ProcessManager.BackgroundWorker.exe" | Out-File run.cmd -Encoding ASCII;$LASTEXITCODE
       #"dotnet ProcessManager.BackgroundWorker.dll" | Out-File run.cmd -Encoding ASCII;$LASTEXITCODE
      workingDirectory: '$(build.artifactstagingdirectory)/ProcessManager.API/App_Data/jobs/continuous/ProcessManager.BackgroundWorker/'
      displayName: 'Create run.cmd'
    - task: CopyFiles@2
      displayName: 'Copy ProcessManager.BackgroundWorker.SendEvents to ProcessManager.API folder'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)/ProcessManager.BackgroundWorker.SendEvents'
        TargetFolder: '$(build.artifactstagingdirectory)/ProcessManager.API/App_Data/jobs/continuous/ProcessManager.BackgroundWorker.SendEvents/'
    - pwsh: |
       "ProcessManager.BackgroundWorker.SendEvents.exe" | Out-File run.cmd -Encoding ASCII;$LASTEXITCODE
       #"dotnet ProcessManager.BackgroundWorker.SendEvents.dll" | Out-File run.cmd -Encoding ASCII;$LASTEXITCODE
      workingDirectory: '$(build.artifactstagingdirectory)/ProcessManager.API/App_Data/jobs/continuous/ProcessManager.BackgroundWorker.SendEvents/'
      displayName: 'Create run.cmd' 
    - task: CopyFiles@2
      displayName: 'Copy ProcessManager.BackgroundWorker.StartLogicApps to ProcessManager.API folder'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)/ProcessManager.BackgroundWorker.StartLogicApps'
        TargetFolder: '$(build.artifactstagingdirectory)/ProcessManager.API/App_Data/jobs/continuous/ProcessManager.BackgroundWorker.StartLogicApps/'
    - pwsh: |
       "ProcessManager.BackgroundWorker.StartLogicApps.exe" | Out-File run.cmd -Encoding ASCII;$LASTEXITCODE
       #"dotnet ProcessManager.BackgroundWorker.StartLogicApps.dll" | Out-File run.cmd -Encoding ASCII;$LASTEXITCODE
      workingDirectory: '$(build.artifactstagingdirectory)/ProcessManager.API/App_Data/jobs/continuous/ProcessManager.BackgroundWorker.StartLogicApps/'
      displayName: 'Create run.cmd' 
    # Generate version based on source
    - template: Pipelines/Templates/Tasks/version_releaseflow.yml@devops
      parameters:
        SourcePath: '$(Build.SourcesDirectory)/$(Build.Repository.Name)'

    # Software Composition Analysis
    - template: Pipelines/Templates/Tasks/SCA_scanning.yml@devops
      parameters:
        applicationId: 'Neo.PlatformServices.ProcessManager.API'
        solution: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/ProcessManager.sln' 
        nugetConfig: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/nuget.config'
        nexusIqService: 'FD Nexus-Core'  

    # Package build artifacts
    - template: Pipelines/Templates/Tasks/package_releaseflow.yml@devops
      parameters:
        basePath: '$(build.artifactstagingdirectory)/ProcessManager.API/'
        packageID: 'ProcessManager.Service'
        ArtifactsFeed: '$(Reloaded_Publishing_Feed)'